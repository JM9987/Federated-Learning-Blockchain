{"ast":null,"code":"'use strict';\n\nconst mergeOptions = require('merge-options').bind({\n  ignoreUndefined: true\n});\n\nconst toMfsPath = require('./utils/to-mfs-path');\n\nconst log = require('debug')('ipfs:mfs:touch');\n\nconst errCode = require('err-code');\n\nconst UnixFS = require('ipfs-unixfs');\n\nconst toTrail = require('./utils/to-trail');\n\nconst addLink = require('./utils/add-link');\n\nconst updateTree = require('./utils/update-tree');\n\nconst updateMfsRoot = require('./utils/update-mfs-root');\n\nconst _require = require('ipld-dag-pb'),\n      DAGNode = _require.DAGNode;\n\nconst mc = require('multicodec');\n\nconst mh = require('multihashing-async').multihash;\n\nconst withTimeoutOption = require('ipfs-core-utils/src/with-timeout-option');\n\nconst defaultOptions = {\n  /** @type {ToMTime|undefined} */\n  mtime: undefined,\n  flush: true,\n  shardSplitThreshold: 1000,\n  cidVersion: 0,\n  hashAlg: 'sha2-256',\n  signal: undefined\n};\n\nmodule.exports = context => {\n  /**\n   * Update the mtime of a file or directory\n   *\n   * @param {string} path - The MFS path to update the mtime for\n   * @param {TouchOptions & AbortOptions} [options]\n   * @returns {Promise<void>}\n   *\n   * @example\n   * ```js\n   * // set the mtime to the current time\n   * await ipfs.files.touch('/path/to/file.txt')\n   * // set the mtime to a specific time\n   * await ipfs.files.touch('/path/to/file.txt', {\n   *   mtime: new Date('May 23, 2014 14:45:14 -0700')\n   * })\n   * ```\n   */\n  async function mfsTouch(path, options = {}) {\n    const settings = mergeOptions(defaultOptions, options);\n    settings.mtime = settings.mtime || new Date();\n    log(\"Touching \".concat(path, \" mtime: \").concat(settings.mtime));\n\n    const _ref = await toMfsPath(context, path, settings),\n          cid = _ref.cid,\n          mfsDirectory = _ref.mfsDirectory,\n          name = _ref.name,\n          exists = _ref.exists;\n\n    let node;\n    let updatedCid;\n    let cidVersion = settings.cidVersion;\n\n    if (!exists) {\n      const metadata = new UnixFS({\n        type: 'file',\n        mtime: settings.mtime\n      });\n      node = new DAGNode(metadata.marshal());\n      updatedCid = await context.ipld.put(node, mc.DAG_PB, {\n        cidVersion: settings.cidVersion,\n        hashAlg: mh.names['sha2-256'],\n        onlyHash: !settings.flush\n      });\n    } else {\n      if (cid.codec !== 'dag-pb') {\n        throw errCode(new Error(\"\".concat(path, \" was not a UnixFS node\")), 'ERR_NOT_UNIXFS');\n      }\n\n      cidVersion = cid.version;\n      node = await context.ipld.get(cid);\n      const metadata = UnixFS.unmarshal(node.Data);\n      metadata.mtime = settings.mtime;\n      node = new DAGNode(metadata.marshal(), node.Links);\n      updatedCid = await context.ipld.put(node, mc.DAG_PB, {\n        cidVersion: cid.version,\n        hashAlg: mh.names['sha2-256'],\n        onlyHash: !settings.flush\n      });\n    }\n\n    const trail = await toTrail(context, mfsDirectory);\n    const parent = trail[trail.length - 1];\n    const parentNode = await context.ipld.get(parent.cid);\n    const result = await addLink(context, {\n      parent: parentNode,\n      name: name,\n      cid: updatedCid,\n      size: node.serialize().length,\n      flush: settings.flush,\n      shardSplitThreshold: settings.shardSplitThreshold,\n      hashAlg: 'sha2-256',\n      cidVersion\n    });\n    parent.cid = result.cid; // update the tree with the new child\n\n    const newRootCid = await updateTree(context, trail, settings); // Update the MFS record with the new CID for the root of the tree\n\n    await updateMfsRoot(context, newRootCid, settings);\n  }\n\n  return withTimeoutOption(mfsTouch);\n};\n/**\n * @typedef {Object} TouchOptions\n * @property {ToMTime} [mtime] - A Date object, an object with `{ secs, nsecs }` properties where secs is the number of seconds since (positive) or before (negative) the Unix Epoch began and nsecs is the number of nanoseconds since the last full second, or the output of `process.hrtime()`\n * @property {boolean} [flush=false] - If true the changes will be immediately flushed to disk\n * @property {string} [hashAlg='sha2-256'] - The hash algorithm to use for any updated entries\n * @property {import('cids').CIDVersion} [cidVersion] - The CID version to use for any updated entries\n *\n * @typedef {import('cids')} CID\n * @typedef {import('ipfs-core-types/src/basic').AbortOptions} AbortOptions\n * @typedef {import('ipfs-core-types/src/files').ToMTime} ToMTime\n */","map":null,"metadata":{},"sourceType":"script"}